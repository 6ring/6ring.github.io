<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>6ring</title>
<link rel="icon" type="image/png" href="favicon.png">
<style type="text/css">
html, body, iframe { margin: 0; padding: 0; width: 100%; height: 100%; }
button, select { border: 0 none; height: calc(100% - 1px); margin: 0; }
button { cursor: pointer; }
#bar { border-bottom: 1px solid black; background: buttonface; height: 2em; overflow: hidden; }
iframe { display: block; border: 0 none; height: calc(100% - 2em - 1px); }
.open .hidden { display: none; }
.closed .shown { display: none; }
</style>
<script type="text/javascript" src="members.js"></script>
<script type="text/javascript">
if(top != self) top.location = self.location;
self.name = 'sixring';

addEventListener('unload', function(event) { self.name = '' });

addEventListener('popstate', function(event) {
    load(members.get(event.state.id), event.state.url, false);
});

addEventListener('DOMContentLoaded', function(event) {
    let member, url;
    if(history.state) {
        member = members.get(history.state.id);
        url = history.state.url;
    }
    else {
        member = members.get(location.search.substring(1) || 'home');
        url = member.url;
    }

    load(member, url, false);
});

addEventListener('message', function(event) {
    const BASE = 'https://6ring.github.io/';
    let data = event.data;
    switch(data.type) {
        case 'loaded':
        document.title = `6ring · ${data.title}`;
        push(data.url);
        break;

        case 'go':
        if(data.url.startsWith(BASE)) {
            let [action, id] = data.url.substring(BASE.length).split('?', 2);
            switch(action) {
                case '': {
                    let member = members.get(id);
                    let referrer = data.referrer;
                    load(member, referrer.startsWith(member.url)
                        ? referrer : member.url, true);
                }
                break;

                case 'next': select(members.next(id)); break;
                case 'prev': select(members.prev(id)); break;
            }
        }
        else if(data.url.startsWith(members.get(history.state.id).url))
            push(data.url);
        else location.href = data.url;
        break;
    }
});

function push(url) {
    if(url !== history.state.url) {
        history.pushState({ id: history.state.id, url: url },
            document.title, location.search);
    }
}

function load(member, url, push) {
    let id = member.id;
    let title = `6ring · ${member.name}`;
    let address = '?' + (id === 'home' ? '' : id);
    let state = { id: id, url: url };

    if(push) history.pushState(state, title, address);
    else history.replaceState(state, title, address);

    document.title = title;
    document.getElementById(id).selected = true;
    frames[0].location.replace(url);
}

function select(member) {
    load(member, member.url, true);
}

let optionHTML = m =>
    `<option id="${m.id}" value="${m.id}">${m.icon} ${m.name}</option>`;

let selectHTML = code =>
    `<select size="1" class="shown" onchange="select(members.get(this.value))">${code}</select>`;
</script>
</head>
<body>
<div id="bar" class="open"
><button
  onclick="this.parentNode.className = 'closed'"
  class="shown"
  title="hide navigation">◁ ≡</button
><button
  onclick="this.parentNode.className = 'open'"
  class="hidden"
  title="show navigation">≡ ▷</button
><button
  onclick="select(members.prev(history.state.id))"
  class="shown"
  title="previous member site">⮜⮜ prev</button
><script type="text/javascript">
document.write(selectHTML(members.list.map(optionHTML).join('')));
</script
><button
  onclick="select(members.next(history.state.id))"
  class="shown"
  title="next member site">next ⮞⮞</button
><button
 onclick="select(members.random(history.state.id))"
 title="random member site">🎲 random</button
><button
  onclick="select(members.get('home'))"
  title="ring home">🦋 home</button
><button
  onclick="select(members.get('chat'))"
  title="IRC chat">💬 chat</button
><button
  onclick="location.href = history.state.url"
  title="unload ring">❌ exit</button
><button
  onclick="location.href = 'https://github.com/6ring/6ring.github.io/issues'"
  title="bug tracker">🐞 bugs</button
></div>
<iframe src="about:blank"></iframe>
</body>
</html>
