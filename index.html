<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>6ring</title>
<link rel="icon" type="image/png" href="favicon.png">
<style type="text/css">
html, body, iframe { margin: 0; padding: 0; width: 100%; height: 100%; }
button, select { border: 0 none; height: calc(100% - 1px); margin: 0; }
button { cursor: pointer; }
#bar { border-bottom: 1px solid black; background: buttonface; height: 2em; overflow: hidden; }
iframe { display: block; border: 0 none; height: calc(100% - 2em - 1px); }
.open .hidden { display: none; }
.closed .shown { display: none; }
</style>
<script type="text/javascript" src="members.js"></script>
<script type="text/javascript">
if(top !== self)
    top.location = self.location;

class State {
    constructor(object) { this.object = object }

    get id() { return this.object.id }
    get url() { return this.object.url }
    get title() { return this.object.title }
    get address() { return this.id === 'home' ? '?' : '?' + this.id }

    load(push) {
        let obj = this.object;
        let title = `6ring · ${this.title}`;

        if(push) history.pushState(obj, title, this.address);
        else history.replaceState(obj, title, this.address);

        document.title = title;
        document.getElementById(this.id).selected = true;
        frames[0].location.replace(this.url);
    }

    static get current() {
        return history.state ? new State(history.state) : null;
    }

    static create(id, url, title) {
        return new State({ id, url, title });
    }
}

for(let member of members.list)
    member.state = State.create(member.id, member.url, member.name);

addEventListener('popstate', function(event) {
    State.current.load(false);
});

addEventListener('DOMContentLoaded', function(event) {
    (State.current || members.get(location.search.substring(1) || 'home').state)
        .load(false);
});

addEventListener('message', function(event) {
    console.log('TODO');
/*
    const BASE = 'https://6ring.github.io/';
    let data = event.data;
    switch(data.type) {
        case 'loaded':
        document.title = `6ring · ${data.title}`;
        push(data.url);
        break;

        case 'go':
        if(data.url.startsWith(BASE)) {
            let [action, id] = data.url.substring(BASE.length).split('?', 2);
            switch(action) {
                case '': {
                    let member = members.get(id);
                    let referrer = data.referrer;
                    load(member, referrer.startsWith(member.url)
                        ? referrer : member.url, true);
                }
                break;

                case 'next': select(members.next(id)); break;
                case 'prev': select(members.prev(id)); break;
            }
        }
        else if(data.url.startsWith(members.get(history.state.id).url))
            push(data.url);
        else location.href = data.url;
        break;
    }
*/
});

function load(id) { members.get(id).state.load(true) }
function loadPrev() { members.prev(history.state.id).state.load(true) }
function loadNext() { members.next(history.state.id).state.load(true) }
function loadRandom() { members.random(history.state.id).state.load(true) }
function exit(url) { location.href = url }

let optionHTML = m =>
    `<option id="${m.id}" value="${m.id}">${m.icon} ${m.name}</option>`;

let selectHTML = code =>
    `<select size="1" class="shown" onchange="load(this.value)">${code}</select>`;
</script>
</head>
<body>
<div id="bar" class="open"
><button
  onclick="this.parentNode.className = 'closed'"
  class="shown"
  title="hide navigation">◁ ≡</button
><button
  onclick="this.parentNode.className = 'open'"
  class="hidden"
  title="show navigation">≡ ▷</button
><button
  onclick="loadPrev()"
  class="shown"
  title="previous member site">⮜⮜ prev</button
><script type="text/javascript">
document.write(selectHTML(members.list.map(optionHTML).join('')));
</script
><button
  onclick="loadNext()"
  class="shown"
  title="next member site">next ⮞⮞</button
><button
 onclick="loadRandom()"
 title="random member site">🎲 random</button
><button
  onclick="load('home')"
  title="ring home">🦋 home</button
><button
  onclick="load('chat')"
  title="IRC chat">💬 chat</button
><button
  onclick="exit(history.state.url)"
  title="unload ring">❌ exit</button
><button
  onclick="exit('https://github.com/6ring/6ring.github.io/issues')"
  title="bug tracker">🐞 bugs</button
></div>
<iframe src="about:blank"></iframe>
</body>
</html>
